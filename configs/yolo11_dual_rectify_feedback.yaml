# Ultralytics YOLO ðŸš€, AGPL-3.0 license
# EXP 12: Dual-Stream Rectified Feedback (FINAL MATCHED VERSION)
# Architecture:
# - Backbone: Dual-Stream (RGB: YOLOv11s, NIR: YOLOv11n)
# - Interaction: FusionRectifyFeedback at P3 & P4
# - Fusion: FusionRectify at P5
# - Head: Standard PANet detecting on [P3, P4, P5]

# Parameters
nc: 4 # Sá»‘ class
scales:
  custom: [1.00, 1.00, 1024]

backbone:
  # [from, repeats, module, args]
  - [-1, 1, InputContainer, []] # 0

  # ==========================================
  # GIAI ÄOáº N 1: STEM (Khá»Ÿi Ä‘á»™ng)
  # ==========================================
  # --- RGB Branch (YOLOv11s) ---
  - [0, 1, Conv, [32, 3, 2]] # 1
  - [-1, 1, Conv, [64, 3, 2]] # 2
  - [-1, 1, C3k2, [128, False, 0.25]] # 3

  # --- NIR Branch (YOLOv11n) ---
  - [0, 1, Conv, [16, 3, 2]] # 4
  - [-1, 1, Conv, [32, 3, 2]] # 5
  - [-1, 1, C3k2, [64, False, 0.25]] # 6

  # ==========================================
  # GIAI ÄOáº N 2: P3 (TARGET 128 CHANNELS)
  # ==========================================
  # --- RGB P3 Generation ---
  - [3, 1, Conv, [128, 3, 2]] # 7
  - [-1, 1, C3k2, [128, False, 0.5]] # 8 (MATCH YOLOv11s P3)

  # --- NIR P3 Generation ---
  - [6, 1, Conv, [64, 3, 2]] # 9
  - [-1, 1, C3k2, [128, False, 0.5]] # 10 (Up channel lÃªn 128 cho khá»e)
  - [-1, 1, Conv, [128, 1, 1]] # 11 (Ã‰p kÃªnh NIR = 128 Ä‘á»ƒ khá»›p RGB)

  # >>> INTERACTION BLOCK 1 <<<
  # RGB vÃ  NIR trao Ä‘á»•i thÃ´ng tin táº¡i Ä‘Ã¢y
  - [[8, 11], 1, FusionRectifyFeedback, []] # 12

  # --- Selectors (TÃ¡ch luá»“ng Ä‘á»ƒ Ä‘i tiáº¿p) ---
  - [12, 1, Conv, [128, 1, 1]] # 13 (RGB P3 New - ÄÃ£ Ä‘Æ°á»£c Rectify)
  - [12, 1, Conv, [128, 1, 1]] # 14 (NIR P3 New - ÄÃ£ Ä‘Æ°á»£c Rectify)

  # ==========================================
  # GIAI ÄOáº N 3: P4 (TARGET 256 CHANNELS)
  # ==========================================
  # --- RGB P4 Generation ---
  - [13, 1, Conv, [256, 3, 2]] # 15 (Input láº¥y tá»« Layer 13)
  - [-1, 1, C3k2, [256, True, 0.5]] # 16 (MATCH YOLOv11s P4)

  # --- NIR P4 Generation ---
  - [14, 1, Conv, [128, 3, 2]] # 17 (Input láº¥y tá»« Layer 14)
  - [-1, 1, C3k2, [128, True, 0.5]] # 18
  - [-1, 1, Conv, [256, 1, 1]] # 19 (Ã‰p kÃªnh NIR = 256 Ä‘á»ƒ khá»›p RGB)

  # >>> INTERACTION BLOCK 2 <<<
  - [[16, 19], 1, FusionRectifyFeedback, []] # 20

  # --- Selectors ---
  - [20, 1, Conv, [256, 1, 1]] # 21 (RGB P4 New)
  - [20, 1, Conv, [256, 1, 1]] # 22 (NIR P4 New)

  # ==========================================
  # GIAI ÄOáº N 4: P5 (TARGET 512 CHANNELS)
  # ==========================================
  # --- RGB P5 Generation ---
  - [21, 1, Conv, [512, 3, 2]] # 23 (Input láº¥y tá»« Layer 21)
  - [-1, 1, C3k2, [512, True, 0.5]] # 24 (MATCH YOLOv11s P5)
  - [-1, 1, SPPF, [512, 5]] # 25

  # --- NIR P5 Generation ---
  - [22, 1, Conv, [256, 3, 2]] # 26 (Input láº¥y tá»« Layer 22)
  - [-1, 1, C3k2, [256, True, 0.5]] # 27
  - [-1, 1, SPPF, [256, 5]] # 28

head:
  # ==========================================
  # FINAL FUSION & DETECTION HEAD
  # ==========================================

  # 1. Fusion táº¡i P5 (High Level Context)
  - [28, 1, Conv, [512, 1, 1]] # 29
  - [[25, 29], 1, FusionRectify, []] # 30 -> Fused P5

  # 2. XÃ¢y dá»±ng thÃ¡p Ä‘áº·c trÆ°ng (Feature Pyramid)
  # Upsample P5 -> P4
  - [30, 1, nn.Upsample, [None, 2, "nearest"]] # 31
  - [[-1, 21], 1, Concat, [1]] # 32 (Concat vá»›i P4 RGB Enhanced)
  - [-1, 1, C3k2, [512, False]] # 33

  # Upsample P4 -> P3
  - [33, 1, nn.Upsample, [None, 2, "nearest"]] # 34
  - [[-1, 13], 1, Concat, [1]] # 35 (Concat vá»›i P3 RGB Enhanced - Cá»©u váº­t thá»ƒ nhá»)
  - [-1, 1, C3k2, [256, False]] # 36

  # Downsample P3 -> P4
  - [36, 1, Conv, [256, 3, 2]] # 37
  - [[-1, 33], 1, Concat, [1]] # 38
  - [-1, 1, C3k2, [512, False]] # 39

  # Downsample P4 -> P5
  - [39, 1, Conv, [512, 3, 2]] # 40
  - [[-1, 30], 1, Concat, [1]] # 41
  - [-1, 1, C3k2, [512, True]] # 42

  # 3. Detect Head
  - [[36, 39, 42], 1, Detect, [nc]] # 43
